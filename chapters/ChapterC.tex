% !Mode:: "TeX:UTF-8"

\chapter{立体匹配方法及优化}

立体匹配是双目视觉系统的核心问题，通过立体匹配寻找两幅图像中对应的像素点的位置，得出匹配结果，通常用视差图表示，从而进一步求出深度信息。本章将着重介绍立体匹配方法，基于多种分类方式研究各种立体匹配方法的实现优缺点，以及如何提高立体匹配的精确度，在立体匹配过程中存在的各种各样的难题。

\section{立体匹配方法简介}

从根本上讲，立体匹配方法其实就是通过构建一个能量代价函数\citeup{A-13}，来最小化估计像素点视差值的一个过程。立体匹配方法实质是一个最优化求解问题，算法通过建立一个合理的能量函数，根据匹配约束条件增加相应的约束公式，结合最优化理论方法进行方程求解，这种求解方法也是典型的病态问题求解。在实际的双目视觉系统中，对采样图像进行拍摄获取时往往受到许多不确定的环境因素干扰，曝光不一致，抖动等问题都提高了立体匹配的难度，如何减少不利因素带来的影响，获得具有高准确匹配率的图像匹配结果是立体匹配技术的难点也是要攻克的核心问题。

随着各方面条件成熟，立体匹配方法迅速发展，现在已经出现了各种各样的匹配算法，它们各具优势各具特色，不过这些算法都离不开几个重要的组成部分，只是在各个部分存在实现的差异。立体匹配方法的这几个重要部分为匹配代价计算，匹配代价聚集，视差最优化计算，视差细化四个部分\citeup{A-3}。
\pic[h]{立体匹配常见算法分类}{keepaspectratio=false}{3-1}

匹配代价计算：基于灰度差值的绝对值匹配代价计算方法是这个步骤常用的一种代价方法，此外还有基于灰度值差值平方的绝对值来计算匹配代价，归一化互相关等，不过这往往只是算法基础，通常还要在对匹配代价函数添加一些参数因子或者进行一些变换以提高匹配准确度。

匹配代价聚集：输入单个参考像素进行匹配代价计算后，由于存在较大的误差，所以必须按照一定的区域计算匹配像素点周围若干像素的匹配代价结果，再对统计结果进行比较判断，找出对应像素点，提高匹配准确度，聚集像素匹配代价结果的通常为有固定视差的二维区域，窗口有简单的固定窗口，能够适应不同图像区域的可变窗口和自适应窗口等等。

视差最优化计算：通过匹配代价聚集之后得到一个最优的匹配像素点，得到视差值，这是局部匹配方法的实现过程，即简单地通过一个像素找到参考图像最优匹配的像素求出视差，即所谓的赢者通吃法(Winner Take All)。这个方法没有考虑到其他像素点的匹配情况，所以匹配正确率较差，通过视差优化可以平衡匹配效果，达到整体最优。

视差细化：通过视差细化可以进一步提高立体匹配效果，输出更加标准的视差图，通过一些常用方法对，如中值滤波法，消除图像中的噪点；用中间像素视差精练法，用曲线拟合视差变化情况，去除可能出现的毛刺，在图像中的像素灰度变化平滑区域有很好的效果。这一步骤通常是全局匹配方法的最后一步。

\section{立体匹配方法的分类和基本过程}

立体匹配方法作为双目视觉系统中的核心问题，经过多年的研究发展，涌现了各种各样具有不同优势的算法。

若根据匹配基元的不同，主要分为基于特征的立体匹配方法，基于相位的立体匹配方法，还有基于区域的立体匹配方法。基于特征的立体匹配方法中，匹配基元是基于全局优化的图像特征集，如点，边缘，区域特征，从图像特征集中寻找对应关系实现匹配；基于区域的立体匹配方法中，匹配基元是具有一定尺寸的模板窗口，釆用相关函数测量视差范围内待测窗口相似性实现匹配；基于相位的立体匹配方法，其匹配基元是图像相位，利用多尺度的空间频率分析方法，提取图像不同频段的信息进行匹配。匹配原理基本相同，都是基于基元的相似性测量，但适用方法的搜索策略各不相同。

若根据匹配结果的稠密程度，则可分为稠密匹配和稀疏匹配方法。稠密匹配以图像的灰度、邻域相关程度等为判断依据进行匹配，为绝大多数像素找到匹配结果。稀疏匹配是以边缘、轮廓、线段等图像特征为匹配内容进行匹配，也就是基于特征的立体匹配，仅得到特征点处匹配结果。

若根据匹配的优化规则，可以分为全局立体匹配方法和局部立体匹配方法。局部匹配方法在经典的窗口匹配基础上，还有自适应窗体，自适应权值，多窗口匹配等优化方向，局部匹配方法其实也是一种基于区域的立体匹配方法，它们只是分类角度不同而已。全局立体匹配的主要过程是在局部匹配的基础上进行匹配结果优化，主要的全局优化方法有图割法，置信传播，动态规划等。

\pic[h]{立体匹配常见算法分类}{keepaspectratio=false,width=14cm}{3-2}

本文将介绍三种比较常见的立体匹配方法：基于特征的立体匹配方法，全局立体匹配方法，局部立体匹配方法（基于区域的立体匹配方法）。

\subsection{基于特征的立体匹配方法}
像素灰度值是图像的基本特征，不过单一像素的灰度值不能提供足够的信息，无法实现立体匹配，而图像特征可以提供一个更高层次的图像描述。图像特征是一幅图像中局部的、有意义的、可检测的部分。基于特征的匹配算法，主要是基于图像的几何特征信息，如边缘、线、角点、兴趣点和几何基元等，相应不同的图像信息和图像特征选取合适的特征信息，针对这些几何特征进行视差估计，首先必须提取图像的特征点，特征越明显越好，然后获取图像特征点区域的对应的视差图，由此可以看出基于特征的立体匹配方法是一种稀疏的立体匹配方法，它只能对拥有明显特征点的特征区域进行立体匹配。

基于特征的立体匹配方法所需要的主要步骤：图像预处理、提取特征、特征点的匹配，最后获取稀疏视差图，可以通过采用差值估计，插值的方法来获取稠密的视差图。提取特征时可提取图像的点、线、面这些布局特征的分布情况，也可提取图像结构或者多边形等全局特征。基于特征的立体匹配方法运行速度快，缺点是依赖于图像的特征表现，对特征不明显的图像信息难以匹配，此外特征提取过程易受到拍摄环境的影响，遮挡、光线条件、重复纹理等影响较大；差值估计计算量大，对于特征不明显以及要求得到稳定输出视差的双目系统，基于特征的立体匹配方法适合用于一些简单且特征明显的应用场景。

\subsection{全局立体匹配方法}
基于局部区域的立体匹配算法主要通过优化局部窗口内累积代价的计算方式来
估计视差值，这种方法既能在一定程度上保证匹配速度，又能照顾到匹配精度。这
些特质使得局部匹配算法在继特征立体匹配算法之后成为立体匹配领域的研究热点。
但近些年得益于计算机计算能力的大幅提升和计算成本的下降，使得研究者能够越
来越放手的去追求匹配精度。

全局立体匹配算法主要是在局部立体匹配的基础上，根据约束条件，采用一些全局的优化理论方法来估计视差，细化误差，建立全局能量函数，通过最小化全局能量函数得到最优的视差值。可以说全局立体匹配将独立的各个像素点的匹配结果统一起来进行分析，从而得到更加精确的匹配结果，要实现这个过程，十分消耗运算时间。近些年来随着计算机计算能力的大幅提升，计算成本也逐渐降低，全局匹配方法也得到一定程度的发展，往往运用在对匹配结果精确度要求高的场合。

利用匹配约束方法可以解决全局匹配过程中匹配点的选择问题，在中心像素点寻找到多个符合的匹配参考点时，结合约束方法，往往能够得到准确的结果，常用的约束条件包括：极线约束，唯一性约束，顺序一致性约束，视差连续性约束，相似性约束等

全局立体匹配方法常用的全局优化方法有动态规划等，图割法（graphcuts）、信念传播（belief propagation）等等\citeup{A-7}。全局匹配算法特点明确，通过牺牲算法运算时间，得到匹配正确率更高的视差图，因此不适合实时运行，实时匹配的应用场景。

\subsection{局部立体匹配方法}
局部立体匹配算法是立体匹配算法中发展迅速并且应用领域非常广泛的一类算法，局部立体配算法的实质是：通过直接对输入的图像对之间的彩色信息或灰度信息进行匹配，从而得到其中一幅图像对应的视差图。不同于基于特征的匹配算法得到的视差图为稀疏的视差图，大多数局部匹配算法都能得到图像对应的稠密视差图，保留了图像中丰富的视差信息和深度信息。基于以上原因，本课题的研究方向定位局部立体匹配算法的研究和改进，而局部立体匹配算法中，匹配窗口尺寸和形状的选择是一个很重要的因素，一个大小形状合适的窗口对算法的结果影响很大。窗口不能太小，否则，窗口中包含的可用信息太少，导致无匹配的可能性增大。窗口也不能太大，否则，一方面严重影响到匹配效率，一方面可能受到投影畸变的影响。在固定窗口的局部匹配算法中通常使用以中心像素为中心点的正方形窗口。

由于窗口的选择对局部立体匹配算法的效果影响很大，由此形成了以SAD算法为代表的基于窗口的局部立体匹配算法。除了基于窗口的局部匹配算法以外，以此为基础，近年来也出现了一些优化算法，如基于Census变换的局部算法为代表的基于图像变换的局部匹配算法，还有基于傅立叶变换的局部算法、基于Rank变换的局部算法等。此外还有基于自适应权值的局部立体匹配算法，这一类算法的表面采用固定的匹配窗口进行匹配，实际上则是通过自适应的权值为每一个参考像素选择最佳形状和尺寸的匹配窗口，以ASW算法为代表，正是基于自适应权值的局部立体匹配算法将局部立体匹配算法推向了顶峰。

总体而言，局部立体匹配算法可大致分为三类：基于窗口的局部立体匹配算法、基于变换的局部立体匹配算法和基于自适应权值的局部立体匹配算法。 

基于窗口的局部立体匹配算法：顾名思义，即匹配窗口的大小是固定不变的。是局部算法中最为经典也是最为简单的一类。算法简单易于实现，而且匹配效率很高，缺点是算法提取的视差图受窗口大小影响很大，而且视差图中物体的轮廓不清晰，对图像中深度不连续区域的匹配效果较差。

基于变换的局部立体匹配算法：在进行匹配之前，先对匹配窗口进行变换，对经过变换的窗口进行立体匹配，代表算法有基于Census变换的局部立体匹配算法。其他的算法还包括：基于傅立叶变换的局部算法、基于Rank变换的局部算法等。由于该类算法在基于窗口的局部算法的基础上加了图像变换，因此算法复杂度和基于窗口的局部算法略高。由于以上原因，这一类算法效率较高，但提取的视差图中噪点仍然较多，物体边缘轮廓不够清晰。 

基于自适应权值的算法为每一个像素寻找匹配像素点时，不是单独地进行对应窗口像素的灰度值的差值作累积，而是为窗口中的每一个像素对中心像素的贡献设置一个权值（常用的权值有基于颜色的权值和基于几何距离的权值），在窗口区域内与中心像素点关联越大的点对整个窗口匹配代价的影响就越大，通过这种自适应权值的方法可以大大提升图像的整体匹配效果，尤其是在图像的边缘轮廓区域，获取较为清晰的视差图。在匹配效率方面，由于采用固定大小的窗口，因此匹配效率也相对于可变窗口的匹配算法效率高，因此，在双目立体匹配领域被广泛的使用。

局部立体匹配算法使用简单的赢者全胜(Winner Take  All)的视差选择策略，与全局立体匹配算法相比，它通过匹配窗口的全部像
素的累积量来进行匹配。相比全局立体匹配算法，局部立体匹配算法有以下优点： 

匹配稳定性好：区别于基于特征的立体匹配方法，局部立体匹配方法拥有较好的稳定性，不依赖于拍摄目标的特征，针对不同图像区域的局部匹配算法都有较好的匹配效果。

算法复杂度低，运行速率快：目前越来越多的应用环境对系统的响应时间要求很高，甚至很多应用场景要求算法的效率要接近实时运算，因此，虽然全局算法的匹配效果不错，但单从效率上讲，已经是毫无用武之地。鉴于这个原因，局部算法的研究和学习也越来越广泛和深入。 

匹配准确率较好：早期，全局算法备受关注，原因是全局算法获取的视差图质量相比当时的局部算法获取的视差图表现出色很多，但是随着局部算法的进一步研究和改进，目前，许多局部算法提取的视差图的效果已经很好，甚至超出某些全局算法的匹配效果，随着局部算法匹配效率的提高，相应的匹配复杂度也不断提升，即局部算法效果的提升是以牺牲匹配效率为代价的。

尽管局部算法的复杂度不断提升，但是相比于全局算法，在速度方面的优势仍旧是非常显著的，加上优化过后的全局算法也有不俗的匹配输出效果，因此，在某些对实时性和匹配效果并求的应用场景下，局部算法无疑是最佳选择。

\section{立体匹配的难点和算法优化方向}

在双目系统的立体匹配过程中，通常对于左图像中的某一个像素点，通过匹配方法找到的位于右图的匹配候选点往往有多个，而实际上真正的匹配点最多只有一个，遮挡区域的像素则实际上是不能找到匹配点的。而产生多个匹配候选点则会提高误匹配的概率，导致匹配准确度的下降，在图像的遮挡区域，低纹理区域以及深度不连续区域是最容易产生误匹配的地方，这也是立体匹配需要克服的几个难点。也是本文算法优化所要解决的问题。

\pic[h]{局部匹配的难点}{keepaspectratio=false,height=6cm}{3-5}

遮挡区域：由于摄像机在同一水平面平移的原因且光圈大小一致，所以某些区域的像素点不可能同时出现在输入的两幅图像中，存在着左图像有而右图像被遮挡的情况，也就不可能找到对应的匹配点。这种现象就是遮挡，遮挡住的图像区域就是遮挡区域。遮挡是立体匹配过程中面临的主要困难之一，由于前景和背景在不同观察点观察的时候，位置偏移量会有所不同，部分的背景在参考图像上存在，而在目标图像中被遮挡了，使得参考图像中的像素点失去了对应的匹配点，从而造成误匹配。解决遮挡的方法是添加遮挡检测，可以通过多幅图像进行处理，也可以利用交叉检验的方法判断被遮挡像素点，主要是采用后者进行检测遮挡的像素点，再通过后景视差填充，输出遮挡区域的视差图像。 

低纹理区域：该区域内的像素高度相似，比如一张纯色的木桌，通过一般的相似性测量来寻找匹配点，通常会找到多个匹配点与之对应，因为该区域相似性太高，导致难以得到正确匹配结果。弱紋理或重复纹理区域主要是指在某些区域中的像素点，其颜色特征比较相近，即纹理特征并不丰富。通常可以通过增加窗口大小以获取更多中心图像周围的灰度信息来解决，不过在匹配的过程如果窗口的过大也会导致视差图噪点增加，降低其他区域的匹配准确度，所以对于匹配窗口大小的选择必须经过一定的实验验证。

深度不连续区域：这种区域普遍存在于场景中的物体的边缘处，由于物体之间的像素差异而存在的自然区分带，匹配输出视差图常常出现的边缘模糊情况一般就是由于深度不连续区域引起的。一般认为连续性约束只适用于物体表面，在物体边缘处是不满足的。针对这类区域中的像素匹配过程，要提高匹配精度，可以通过采用多个窗体，在每一个窗体中，像素不是总处于窗体的中间位置，而是在不同的位置。然后计算在每类窗体下，计算匹配代价，为每一个像素选择一个最优的窗口。 

下一章将通过具体的实验环境，实现双目视觉系统的基本功能，包括标定求出内外参数，实现立体匹配功能，为了得到更好的立体匹配效果，得到精确的视差图，将在基础的局部立体匹配方法基础上增加一些优化模块，最后通过评估模块和标准图像验证试验结果。
